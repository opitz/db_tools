#!/usr/bin/env bash

# script to localise database $1 for development | auto-generated by bootstrap.sh
# m.opitz@qmul.ac.uk | 2017-10-04

echo "--------------------------------------------------------------------------"
echo "====> Localise $1 database for development use - v.2.4 "

if [ $# -eq 0 ]
  then
    echo "====> ERROR! Missing database name - aborting...!"
    echo "====> use: localise_db <database_name>"
else
    RESULT=`mysqlshow --user=root --password='R00tpass!' $1 2>/dev/null| grep -v Wildcard | grep -o $1`
    if [ "$RESULT" == "$1" ]
        then
        start_time=`date +%s`
#       Replace links in the database
        echo "====> replacing links to MIS db host with 'db_host' - REMEMBER to set your hosts file accordingly!"
        echo "use $1" | mysql -uroot -p'R00tpass!' $1 2>/dev/null
        echo "update mdl_config_plugins set value = 'db_host' where plugin = 'auth/dbsyncother' and name = 'host'" | mysql -uroot -p'R00tpass!' $1 2>/dev/null
        echo "update mdl_config_plugins set value = 'db_host' where plugin = 'block_module_info' and name = 'dbhost'" | mysql -uroot -p'R00tpass!' $1 2>/dev/null
        echo "update mdl_config_plugins set value = 'db_host' where plugin = 'course_rollover' and name = 'db_host'" | mysql -uroot -p'R00tpass!' $1 2>/dev/null
        echo "update mdl_config_plugins set value = 'db_host' where plugin = 'enrol_cohortcateg' and name = 'dbhost'" | mysql -uroot -p'R00tpass!' $1 2>/dev/null
        echo "update mdl_config_plugins set value = 'db_host' where plugin = 'enrol_database' and name = 'dbhost'" | mysql -uroot -p'R00tpass!' $1 2>/dev/null
        echo "update mdl_config_plugins set value = 'db_host' where plugin = 'local_qmul_sync' and name = 'remote_hostname'" | mysql -uroot -p'R00tpass!' $1 2>/dev/null

#	add user 'qmu_mis_ro'
	echo "CREATE USER 'qmu_mis_ro'@'%' IDENTIFIED BY 'qmu_mis_ro'" | mysql -uroot -p'R00tpass!' $1 2>/dev/null

#	set the password for user 'qmu_mis_ro' to access the data in 'qmu_mis' database
	echo "update mdl_config_plugins set value = 'qmu_mis_ro' where value != '' and ( name = 'dbpass' or name = 'db_pass' or name = 'pass' or name = 'remote_password')"  | mysql -uroot -p'R00tpass!' $1 2>/dev/null

#	set connection type to mysqli
	echo "update mdl_config_plugins set value = 'mysqli' where value = 'mysql'" | mysql -uroot -p'R00tpass!' $1 2>/dev/null

#       set all user accounts to manual login so no shiboleth is used/needed
        echo "====> setting all $1 user accounts to 'manual' login."
        echo "update mdl_user set auth = 'manual'" | mysql -uroot -p'R00tpass!' $1 2>/dev/null

#	add a - hashed - keyword 'testing' for those users where the password has not been set
        echo 'update mdl_user set password = "$2y$10$rT1fTlFceApa/EzhRry1XuoRGi8PgwybtkuwwEjj5w0UAM2qu7O0i" where password = "not cached"' | mysql -uroot -p'R00tpass!' $1 2>/dev/null

#	remove absolute path in default landingpage
        echo "update mdl_config_plugins set value = '/course/view.php?id=3730' where plugin = 'block_landingpage' and name = 'default'" | mysql -uroot -p'R00tpass!' $1 2>/dev/null

#       finish
        echo "====> SUCCESS! Localising of $1 done after $((`date +%s` - start_time)) seconds!    "
        echo " "
    else
        echo "====> ERROR! $1 is not a database - aborting..."
    fi
fi

